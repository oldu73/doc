
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-8.0.3">
    
    
      
        <title>Compose - 10 - Services - Doc</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.62128196.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.9204c3b2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>function __md_scope(e,t,_){return new URL(_||(t===localStorage?"../..":"../.."),location).pathname+"."+e}function __md_get(e,t=localStorage,_){return JSON.parse(t.getItem(__md_scope(e,t,_)))}function __md_set(e,t,_=localStorage,o){try{_.setItem(__md_scope(e,_,o),JSON.stringify(t))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#compose-10-services" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Doc" class="md-header__button md-logo" aria-label="Doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Doc
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Compose - 10 - Services
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Doc" class="md-nav__button md-logo" aria-label="Doc" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Doc
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Agile Methodology
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Agile Methodology" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Agile Methodology
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../agilemethodology/1-agilemethodology-misc/" class="md-nav__link">
        Agile Methodology - 01 - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Docker" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Docker
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../1-docker-misc/" class="md-nav__link">
        Docker - 01 - Misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../2-docker-basis/" class="md-nav__link">
        Docker - 02 - Basis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../3-docker-dockerfile/" class="md-nav__link">
        Docker - 03 - Docker File
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../4-docker-dockerhub/" class="md-nav__link">
        Docker - 04 - Docker Hub
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../5-docker-nodeserver/" class="md-nav__link">
        Docker - 05 - Node Server
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../6-docker-datapersistence/" class="md-nav__link">
        Docker - 06 - Data Persistence
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../7-docker-network/" class="md-nav__link">
        Docker - 07 - Network
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../8-compose-use/" class="md-nav__link">
        Compose - 08 - Use
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../9-compose-dockerfile/" class="md-nav__link">
        Compose - 09 - Dockerfile
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Compose - 10 - Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Compose - 10 - Services
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-architecture" class="md-nav__link">
    Project architecture
  </a>
  
    <nav class="md-nav" aria-label="Project architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    Development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production" class="md-nav__link">
    Production
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    Client configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-nodejs-api" class="md-nav__link">
    Set up Node.js API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-database-service" class="md-nav__link">
    Set up database service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-the-nginx-reverse-proxy" class="md-nav__link">
    Set up the NGINX reverse proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-production-configuration" class="md-nav__link">
    Set up production configuration
  </a>
  
    <nav class="md-nav" aria-label="Set up production configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client" class="md-nav__link">
    Client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#db" class="md-nav__link">
    DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverse-proxy" class="md-nav__link">
    Reverse proxy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../11-compose-production/" class="md-nav__link">
        Compose - 11 - Production
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          ElasticSearch
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="ElasticSearch" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          ElasticSearch
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../elasticsearch/elasticsearch/" class="md-nav__link">
        ElasticSearch - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Git
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Git" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Git
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../git/git/" class="md-nav__link">
        Git - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          IntelliJ
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="IntelliJ" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          IntelliJ
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../intellij/1-intellij-misc/" class="md-nav__link">
        IntelliJ - 01 - Misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../intellij/2-intellij-wsl/" class="md-nav__link">
        IntelliJ - 02 - WSL
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Java
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Java" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Java
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_1" type="checkbox" id="__nav_7_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_1">
          test
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="test" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_1">
          <span class="md-nav__icon md-icon"></span>
          test
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../java/test/mock/" class="md-nav__link">
        mock
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          JavaScript
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="JavaScript" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          JavaScript
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/misc/" class="md-nav__link">
        misc
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2" type="checkbox" id="__nav_8_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_2">
          training
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="training" data-md-level="2">
        <label class="md-nav__title" for="__nav_8_2">
          <span class="md-nav__icon md-icon"></span>
          training
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2_1" type="checkbox" id="__nav_8_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_2_1">
          02-environment
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="02-environment" data-md-level="3">
        <label class="md-nav__title" for="__nav_8_2_1">
          <span class="md-nav__icon md-icon"></span>
          02-environment
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/02-environment/06-install-environnement/" class="md-nav__link">
        06-install-environnement
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/02-environment/08-install-babel/" class="md-nav__link">
        08-install-babel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/02-environment/09-javascript-in-html/" class="md-nav__link">
        09-javascript-in-html
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/02-environment/10-webpack/" class="md-nav__link">
        10-webpack
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/02-environment/11-console/" class="md-nav__link">
        11-console
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8_2_2" type="checkbox" id="__nav_8_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8_2_2">
          03-basis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="03-basis" data-md-level="3">
        <label class="md-nav__title" for="__nav_8_2_2">
          <span class="md-nav__icon md-icon"></span>
          03-basis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/03-basis/12-intro-and-var/" class="md-nav__link">
        12-intro-and-var
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/03-basis/13-let-and-const/" class="md-nav__link">
        13-let-and-const
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/03-basis/14-hoisting/" class="md-nav__link">
        14-hoisting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../javascript/training/03-basis/15-types/" class="md-nav__link">
        15-types
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Kafka
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Kafka" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Kafka
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../kafka/1-kafka-misc/" class="md-nav__link">
        Kafka - 01 - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Linux
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Linux" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Linux
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../linux/1-linux-misc/" class="md-nav__link">
        Linux - 01 - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          MkDocs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MkDocs" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          MkDocs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mkdocs/mkdocs/" class="md-nav__link">
        MkDocs - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_12" type="checkbox" id="__nav_12" >
      
      
      
      
        <label class="md-nav__link" for="__nav_12">
          MongoDB
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MongoDB" data-md-level="1">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          MongoDB
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mongodb/mongodb/" class="md-nav__link">
        MongoDB - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_13" type="checkbox" id="__nav_13" >
      
      
      
      
        <label class="md-nav__link" for="__nav_13">
          Redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Redis" data-md-level="1">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          Redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../redis/1-redis-misc/" class="md-nav__link">
        Redis - 01 - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_14" type="checkbox" id="__nav_14" >
      
      
      
      
        <label class="md-nav__link" for="__nav_14">
          VS Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="VS Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          VS Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../vscode/vscode/" class="md-nav__link">
        VS Code - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_15" type="checkbox" id="__nav_15" >
      
      
      
      
        <label class="md-nav__link" for="__nav_15">
          Windows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Windows" data-md-level="1">
        <label class="md-nav__title" for="__nav_15">
          <span class="md-nav__icon md-icon"></span>
          Windows
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../windows/windows/" class="md-nav__link">
        Windows - Misc
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#project-architecture" class="md-nav__link">
    Project architecture
  </a>
  
    <nav class="md-nav" aria-label="Project architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    Development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#production" class="md-nav__link">
    Production
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-configuration" class="md-nav__link">
    Client configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-nodejs-api" class="md-nav__link">
    Set up Node.js API
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-database-service" class="md-nav__link">
    Set up database service
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-the-nginx-reverse-proxy" class="md-nav__link">
    Set up the NGINX reverse proxy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#set-up-production-configuration" class="md-nav__link">
    Set up production configuration
  </a>
  
    <nav class="md-nav" aria-label="Set up production configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#client" class="md-nav__link">
    Client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    API
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#db" class="md-nav__link">
    DB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reverse-proxy" class="md-nav__link">
    Reverse proxy
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                

<h1 id="compose-10-services">Compose - 10 - Services</h1>
<p>Docker Compose - Services</p>
<p>Use of Docker Compose with many services.</p>
<p>In this chapter we setup a complete development/production environnement close to what we may found in real life projects, scalable and so on.</p>
<hr />
<h2 id="project-architecture">Project architecture</h2>
<p>Introduction to project architecture:</p>
<ul>
<li>React (Application), could be Vue.js or Angular, would be the same.  </li>
<li>NGINX (Http request).  </li>
<li>Node.js (API).  </li>
<li>MongoDB (database).</li>
</ul>
<h3 id="development">Development</h3>
<p>NGINX as reverse proxy follow requests:</p>
<ul>
<li>!= /api + == /sockjs-node (websocket for live reload feature) -&gt; React.  </li>
<li>== /api -&gt; Node.js -&gt; MongoDB.</li>
</ul>
<h3 id="production">Production</h3>
<p>NGINX as reverse proxy (on big application may also be used as a load balancer) follow requests:</p>
<ul>
<li>!= /api -&gt; another NGINX that handle React production build output ('build' folder).  </li>
<li>== /api -&gt; Node.js -&gt; MongoDB.</li>
</ul>
<h3 id="setup">Setup</h3>
<pre><code class="language-console">mkdir fullstack
cd fullstack
</code></pre>
<p>React application:</p>
<pre><code class="language-console">mkdir client
</code></pre>
<p>Node.js application:</p>
<pre><code class="language-console">mkdir api
</code></pre>
<p>MongoDB database:</p>
<pre><code class="language-console">mkdir db
</code></pre>
<p>NGINX as a reverse proxy, in charge of dispatching http requests:</p>
<pre><code class="language-console">mkdir reverse-proxy
</code></pre>
<p>Docker Compose:</p>
<pre><code class="language-console">touch docker-compose.dev.yml
touch docker-compose.prod.yml
</code></pre>
<hr />
<h2 id="client-configuration">Client configuration</h2>
<p>Setting up the client configuration</p>
<pre><code class="language-console">cd client
npx create-react-app client
mv client/* .
rm -rf client
rm -rf node_modules
touch Dockerfile.dev
</code></pre>
<p>/fullstack/client/Dockerfile.dev:</p>
<pre><code class="language-text">FROM node:alpine
WORKDIR /app
COPY package.json .
RUN npm install
# To avoid 'EACCES: permission denied' issue on '/app/node_modules/.cache' folder
RUN mkdir -p node_modules/.cache &amp;&amp; chmod -R 777 node_modules/.cache
COPY . .
CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre>
<p>/fullstack/docker-compose.dev.yml:</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    volumes:
      - type: bind
        source: ./client
        target: /app
      - type: volume
        target: /app/node_modules
    ports:
      - 3000:3000
</code></pre>
<p>From 'fullstack' folder, we'll let '--build' option to ensure building images before starting containers:</p>
<pre><code class="language-console">code .
docker-compose -f docker-compose.dev.yml up --build
</code></pre>
<p>Test by browsing at <a href="http://localhost:3000/">localhost:3000</a></p>
<p>We add a function to '/fullstack/client/src/App.js' file in order to get a counter from api (not ready yet but we prepare here the application in advance).</p>
<p>/fullstack/client/src/App.js:</p>
<pre><code class="language-javascript">import logo from './logo.svg';
import './App.css';
import { useState, useEffect } from 'react';

function App() {
  const [count, setCount] = useState();

  useEffect(() =&gt; {
    async function fetchCount() {
      try {
        const response = await fetch('/api/count')
        if (response.ok) {
          setCount(await response.json());
        }
      } catch (e) {
        console.log(e);
      }
    }
    fetchCount();
  }, []);

  return (
    &lt;div className=&quot;App&quot;&gt;
      &lt;header className=&quot;App-header&quot;&gt;
        &lt;img src={logo} className=&quot;App-logo&quot; alt=&quot;logo&quot; /&gt;
        &lt;p&gt;
          Edit &lt;code&gt;src/App.js&lt;/code&gt; and save to reload.
        &lt;/p&gt;
        &lt;p&gt;
          Count : { count }
        &lt;/p&gt;
        &lt;a
          className=&quot;App-link&quot;
          href=&quot;https://reactjs.org&quot;
          target=&quot;_blank&quot;
          rel=&quot;noopener noreferrer&quot;
        &gt;
          Learn React
        &lt;/a&gt;
      &lt;/header&gt;
    &lt;/div&gt;
  );
}

export default App;
</code></pre>
<p>In Docker Compose logs we may observe successful compilation:</p>
<pre><code class="language-console">.
.
client_1  | webpack 5.65.0 compiled successfully in 191 ms
</code></pre>
<p>Test again by browsing at <a href="http://localhost:3000/">localhost:3000</a></p>
<p>Stop/remove stack:</p>
<pre><code class="language-console">docker-compose -f docker-compose.dev.yml down
</code></pre>
<p>Note: - webpack is exclusively devoted for development.</p>
<hr />
<h2 id="set-up-nodejs-api">Set up Node.js API</h2>
<p>From project root folder: - .../fullstack</p>
<pre><code class="language-console">cd api
npm init -y
npm i express nodemon mongodb
mkdir src
cd src
touch index.js
</code></pre>
<p>index.js (from previous node server project)</p>
<pre><code class="language-javascript">const express = require(&quot;express&quot;);

const MongoClient = require('mongodb').MongoClient;

let count;

const MongUrl = process.env.NODE_ENV === 'production' ? 
`mongodb://${ process.env.MONGO_USERNAME }:${ process.env.MONGO_PWD }@db` : 
`mongodb://db`

console.log(process.env) // to have environnement variables in logs

MongoClient.connect(MongUrl, { useUnifiedTopology: true }, (err, client) =&gt; {
  if (err) {
    console.log(err);
  } else {
    console.log('CONNECTION DB OK!');
    count = client.db('test').collection(&quot;count&quot;);
  }
});

const app = express();

app.get('/api/count', (req, res) =&gt; {
  console.log('request url: ' + req.url);
  count.findOneAndUpdate({}, { $inc: { count: 1 } }, { returnNewDocument: true }).then((doc) =&gt; {
    const value = doc.value;
    res.status(200).json(value.count);
  })
});

app.all('*', (req, res) =&gt; {
  res.status(404).end();
});

app.listen(80);
</code></pre>
<p>.../fullstack/docker-compose.dev.yml</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    volumes:
      - type: bind
        source: ./client
        target: /app
      - type: volume
        target: /app/node_modules
    ports:
      - 3000:3000
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    volumes:
      - type: bind
        source: ./api/src
        target: /app/src
    ports:
      - 3001:80
</code></pre>
<p>../fullstack/api</p>
<pre><code class="language-console">touch Dockerfile
</code></pre>
<p>.../fullstack/api/Dockerfile</p>
<pre><code class="language-text">FROM node:alpine
WORKDIR /app
COPY package.json .
RUN npm install
# To avoid 'EACCES: permission denied' issue on '/app/node_modules/.cache' folder
RUN mkdir -p node_modules/.cache &amp;&amp; chmod -R 777 node_modules/.cache
COPY . .
EXPOSE 80
CMD [&quot;npm&quot;, &quot;start&quot;]
</code></pre>
<p>.../fullstack/api/package.json</p>
<pre><code class="language-json">{
  &quot;name&quot;: &quot;api&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;nodemon ./src/index.js&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;keywords&quot;: [],
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;express&quot;: &quot;^4.17.2&quot;,
    &quot;mongodb&quot;: &quot;^4.3.0&quot;,
    &quot;nodemon&quot;: &quot;^2.0.15&quot;
  }
}

</code></pre>
<p>Test API in a terminal from .../fullstack/ folder</p>
<pre><code class="language-console">code .
docker-compose -f docker-compose.dev.yml run api
</code></pre>
<hr />
<h2 id="set-up-database-service">Set up database service</h2>
<p>Add db service to Docker Compose configuration file.</p>
<p>.../fullstack/docker-compose.dev.yml:</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    volumes:
      - type: bind
        source: ./client
        target: /app
      - type: volume
        target: /app/node_modules
    ports:
      - 3000:3000
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    volumes:
      - type: bind
        source: ./api/src
        target: /app/src
    ports:
      - 3001:80
  db:
    image: mongo
    volumes:
      - type: volume
        source: dbtest
        target: /data/db
volumes:
  dbtest:
</code></pre>
<p>Initialize database container.</p>
<p>From '.../fullstack' folder:</p>
<pre><code class="language-console">docker-compose -f docker-compose.dev.yml run db
</code></pre>
<p>Now it should be launch and we connect on it in a second terminal:</p>
<pre><code class="language-console">docker container exec -it fullstack_db_run_c97d6cfbd602 sh
mongo
use test
db.count.insertOne({ count: 0 })
exit
exit
</code></pre>
<p>Now it's OK, we may close second terminal and 'Ctrl+c' database container.</p>
<p>We may test application with (from '.../fullstack' folder):</p>
<pre><code class="language-console">(code . // it's always better to have VS Code started from application root folder)
docker-compose -f docker-compose.dev.yml up
</code></pre>
<p>Test application by browsing to <a href="http://localhost:3001/api/count">http://localhost:3001/api/count</a></p>
<p>We may also observe that React is running by browsing to <a href="http://localhost:3000/">http://localhost:3000/</a></p>
<p>Then 'Ctrl-c' to stop stack.</p>
<hr />
<h2 id="set-up-the-nginx-reverse-proxy">Set up the NGINX reverse proxy</h2>
<p>From '.../fullstack/reverse-proxy' folder:</p>
<pre><code class="language-console">mkdir conf
touch conf/dev.conf
touch Dockerfile.dev
</code></pre>
<p>.../fullstack/reverse-proxy/Dockerfile.dev:</p>
<pre><code class="language-text">FROM nginx:latest
COPY ./conf/dev.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
</code></pre>
<p>.../fullstack/reverse-proxy/conf/dev.conf:</p>
<pre><code class="language-text">server {
    listen 80;

    location / {
        proxy_pass http://client:3000;
    }

    location /api {
        proxy_pass http://api;
    }

    location /sockjs-node {
        proxy_pass http://client:3000;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &quot;upgrade&quot;;
    }
}
</code></pre>
<p>No need to specify port for api because inside stack (network), not from a host point of view, it's listening on default http port ('80').</p>
<p>Among HTTP standards, by default some 'headers' called 'hop-by-hop' aren't passed by proxy to server and then avoid live reload to work.</p>
<p>To fix this, the 'sockjs-node' is a needed technical part to make live reload works.</p>
<p>.../fullstack/docker-compose.dev.yml:</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.dev
    volumes:
      - type: bind
        source: ./client
        target: /app
      - type: volume
        target: /app/node_modules
    ports:
      - 3000:3000
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    volumes:
      - type: bind
        source: ./api/src
        target: /app/src
    ports:
      - 3001:80
  db:
    image: mongo
    volumes:
      - type: volume
        source: dbtest
        target: /data/db
  reverse-proxy:
    build:
      context: ./reverse-proxy
      dockerfile: Dockerfile.dev
    ports:
      - 80:80
    depends_on:
      - api
      - db
volumes:
  dbtest:
</code></pre>
<p>Test, everything is supposed to work:</p>
<pre><code class="language-console">docker-compose -f docker-compose.dev.yml up --build
</code></pre>
<p>In a second terminal:</p>
<pre><code class="language-console">docker-compose -f docker-compose.dev.yml ps
NAME                        COMMAND                  SERVICE             STATUS              PORTS
fullstack_api_1             &quot;docker-entrypoint.s…&quot;   api                 running             0.0.0.0:3001-&gt;80/tcp
fullstack_client_1          &quot;docker-entrypoint.s…&quot;   client              running             0.0.0.0:3000-&gt;3000/tcp
fullstack_db_1              &quot;docker-entrypoint.s…&quot;   db                  running             27017/tcp
fullstack_reverse-proxy_1   &quot;/docker-entrypoint.…&quot;   reverse-proxy       running             0.0.0.0:80-&gt;80/tcp
</code></pre>
<p>We may observe then the 4 components composing our application are running.</p>
<p>And test by browsing to <a href="http://localhost/">http://localhost/</a>, note that there's not need to specify port this time thanks to NGINX that do his job as a reverse proxy by distributing requests through our application by listening on default http port ('80').</p>
<p>By refreshing the page, you also may observe counter increasing.</p>
<p>To test live reload edit file '.../fullstack/client/src/App.js' and observe live changes in browser window (even without refreshing the page).</p>
<p>We now have a full functional development stack that maybe up with only one command:</p>
<pre><code class="language-console">docker-compose -f docker-compose.dev.yml up
</code></pre>
<hr />
<h2 id="set-up-production-configuration">Set up production configuration</h2>
<p>Reset Docker environnement (if needed):</p>
<pre><code class="language-console">docker system prune -a
docker volume prune
</code></pre>
<h3 id="client">Client</h3>
<p>From folder '.../fullstack/client':</p>
<pre><code class="language-console">touch Dockerfile.prod
</code></pre>
<p>.../fullstack/client/Dockerfile.prod</p>
<pre><code class="language-text">FROM node:alpine as build
WORKDIR /app
COPY package.json .
RUN npm install
# To avoid 'EACCES: permission denied' issue on '/app/node_modules/.cache' folder
RUN mkdir -p node_modules/.cache &amp;&amp; chmod -R 777 node_modules/.cache
COPY . .
RUN npm run build

FROM nginx:latest
COPY --from=build /app/build /usr/share/nginx/html
EXPOSE 80
</code></pre>
<p>! Be aware of <strong>RUN</strong> npm run build, NOT CMD!</p>
<p>.../fullstack/docker-compose.prod.yml</p>
<pre><code class="language-yaml">version: '3.8'
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    restart: unless-stopped
</code></pre>
<p>Start VS Code in '.../fullstack' folder with 'code .' command and then:</p>
<pre><code class="language-console">docker-compose -f docker-compose.prod.yml run -p 80:80 client
</code></pre>
<p>Browse to <a href="http://localhost/">http://localhost/</a> to validate React application is running.</p>
<h3 id="api">API</h3>
<p>In '.../fullstack/api/src/index.js' notice mongodb connection URL with MONGO_USERNAME and MONGO_PWD credentials that comes from process (production) environnement:</p>
<pre><code class="language-javascript">const express = require(&quot;express&quot;);

const MongoClient = require('mongodb').MongoClient;

let count;

const MongUrl = process.env.NODE_ENV === 'production' ? 
`mongodb://${ process.env.MONGO_USERNAME }:${ process.env.MONGO_PWD }@db` : 
`mongodb://db`

console.log(process.env) // to have environnement variables in logs

MongoClient.connect(MongUrl, { useUnifiedTopology: true }, (err, client) =&gt; {
  if (err) {
    console.log(err);
  } else {
    console.log('CONNECTION DB OK!');
    count = client.db('test').collection(&quot;count&quot;);
  }
});

const app = express();

app.get('/api/count', (req, res) =&gt; {
  console.log('request url: ' + req.url);
  count.findOneAndUpdate({}, { $inc: { count: 1 } }, { returnNewDocument: true }).then((doc) =&gt; {
    const value = doc.value;
    res.status(200).json(value.count);
  })
});

app.all('*', (req, res) =&gt; {
  res.status(404).end();
});

app.listen(80);
</code></pre>
<p>In '.../fullstack/api' folder:</p>
<pre><code class="language-console">touch .env
</code></pre>
<p>.../fullstack/api/.env:</p>
<pre><code class="language-text">MONGO_USERNAME=paul
MONGO_PWD=123
</code></pre>
<p>We don't want that secret information to be copied in container:</p>
<pre><code class="language-console">touch .dockerignore
</code></pre>
<p>.../fullstack/api/.dockerignore:</p>
<pre><code class="language-text">.env
</code></pre>
<p>.../fullstack/docker-compose.prod.yml</p>
<pre><code class="language-yaml">version: '3.8'
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    restart: unless-stopped
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - ./api/.env
    environment:
      NODE_ENV: production
    restart: unless-stopped
</code></pre>
<p>Test API with (tanks to "console.log(process.env)" in ".../fullstack/api/src/index.js" we may observe environment variables):</p>
<pre><code class="language-console">docker-compose -f docker-compose.prod.yml run api
{
  .
  .
  .
  MONGO_USERNAME: 'paul',
  .
  .
  MONGO_PWD: '123',
  .
  NODE_ENV: 'production',
  .
  .
}
</code></pre>
<p>Hit 'Ctrl+c' to stop.</p>
<h3 id="db">DB</h3>
<p>Secure the database by providing root username and password through an environment file.</p>
<p>From folder '.../fullstack/db':</p>
<pre><code class="language-console">touch .env
</code></pre>
<p>Get credential syntax from 'Environment Variables' section in <a href="https://hub.docker.com/_/mongo">Mongo image on Docker Hub</a>.</p>
<p>In file '.../fullstack/db/.env' add credentials:</p>
<pre><code class="language-text">MONGO_INITDB_ROOT_USERNAME=admin
MONGO_INITDB_ROOT_PASSWORD=password
</code></pre>
<p>Provide environment file (for root user credentials) and external volume for db service in docker compose configuration file.</p>
<p>Set up db service in '.../fullstack/docker-compose.prod.yml' file:</p>
<pre><code class="language-yaml">version: '3.8'
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    restart: unless-stopped
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - ./api/.env
    environment:
      NODE_ENV: production
    restart: unless-stopped
  db:
    image: mongo
    volumes:
      - type: volume
        source: dbprod
        target: /data/db
    env_file:
      - ./db/.env
    restart: unless-stopped

volumes:
  dbprod:
    external: true
</code></pre>
<p>Create volume 'dbprod':</p>
<pre><code class="language-console">docker volume create dbprod
</code></pre>
<p>Run 'db' container in detached mode from '.../fullstack' folder:</p>
<pre><code class="language-console">docker-compose -f docker-compose.prod.yml run -d db
</code></pre>
<p>Initialize database by connecting to it with root user credentials.</p>
<pre><code class="language-console">docker container exec -it fullstack_db_run_e9fa9328e2b8 sh
mongo
use admin
db.auth({ user: 'admin', pwd: 'password' })
</code></pre>
<p>Create the needed user for API access, the one described in '.env' environnement file that reside in '.../fullstack/api' folder.</p>
<pre><code class="language-console">db.createUser({ user: 'paul', pwd: '123', roles: [{ role: 'readWrite', db: 'test' }] })
</code></pre>
<p>Setup collection for 'count'.</p>
<pre><code class="language-console">use test
db.count.insertOne({ count: 0 })
exit
exit
docker stop fullstack_db_run_e9fa9328e2b8
</code></pre>
<p>Now db is ready and API may communicate with it.</p>
<p>To test, launch complete stack with port 80 open for 'api' service (only for testing, because after, in this production context, this is the reverse proxy role to communicate on port 80).</p>
<p>.../fullstack/docker-compose.prod.yml:</p>
<pre><code class="language-yaml">version: '3.8'
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    restart: unless-stopped
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - ./api/.env
    environment:
      NODE_ENV: production
    restart: unless-stopped
    ports:
      - 80:80
  db:
    image: mongo
    volumes:
      - type: volume
        source: dbprod
        target: /data/db
    env_file:
      - ./db/.env
    restart: unless-stopped

volumes:
  dbprod:
    external: true
</code></pre>
<p>Launch full stack:</p>
<pre><code class="language-console">docker-compose -f docker-compose.prod.yml up (--build)
</code></pre>
<p>Browse to <a href="http://localhost/api/count">localhost/api/count</a> and refresh page to observe counter incrementing.</p>
<p>Hit 'Ctrl+c' to stop.</p>
<p>Remove port 80 for 'api' service in 'docker-compose.prod.yml' file.</p>
<h3 id="reverse-proxy">Reverse proxy</h3>
<p>Production configuration file in '.../fullstack/reverse-proxy/conf' folder:</p>
<pre><code class="language-console">touch prod.conf
</code></pre>
<p>Production Docker file in '.../fullstack/reverse-proxy' folder:</p>
<pre><code class="language-console">touch Dockerfile.prod
</code></pre>
<p>.../fullstack/reverse-proxy/Dockerfile.prod:</p>
<pre><code class="language-text">FROM nginx:latest
COPY ./conf/prod.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
</code></pre>
<p>.../fullstack/reverse-proxy/conf/prod.conf:</p>
<pre><code class="language-text">server {
    listen 80;

    location / {
        proxy_pass http://client;
    }

    location /api {
        proxy_pass http://api;
    }
}
</code></pre>
<p>Add 'reverse-proxy' service in '.../fullstack/docker-compose.prod.yml' file:</p>
<pre><code class="language-yaml">version: '3.8'
services:
  client:
    build:
      context: ./client
      dockerfile: Dockerfile.prod
    restart: unless-stopped
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    env_file:
      - ./api/.env
    environment:
      NODE_ENV: production
    restart: unless-stopped
    depends_on:
      - db
  db:
    image: mongo
    volumes:
      - type: volume
        source: dbprod
        target: /data/db
    env_file:
      - ./db/.env
    restart: unless-stopped
  reverse-proxy:
    build:
      context: ./reverse-proxy
      dockerfile: Dockerfile.prod
    ports:
      - 80:80
    restart: unless-stopped
    depends_on:
      - api
      - db
      - client

volumes:
  dbprod:
    external: true
</code></pre>
<p>Test, from '.../fullstack' folder:</p>
<pre><code class="language-console">docker-compose -f docker-compose.prod.yml down -v
docker-compose -f docker-compose.prod.yml up --build
</code></pre>
<p>Browse to <a href="http://localhost">localhost</a> and refresh page to observe counter incrementing.</p>
<hr />

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../9-compose-dockerfile/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Compose - 09 - Dockerfile" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Compose - 09 - Dockerfile
            </div>
          </div>
        </a>
      
      
        
        <a href="../11-compose-production/" class="md-footer__link md-footer__link--next" aria-label="Next: Compose - 11 - Production" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Compose - 11 - Production
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.01824240.min.js"}</script>
    
    
      <script src="../../assets/javascripts/bundle.e0abf5b0.min.js"></script>
      
    
  </body>
</html>