# App Router Client Components

Ref. [Next.js App Router (Client Components)](https://docs.amplify.aws/gen2/start/quickstart/nextjs-app-router-client-components/)

---

## prerequisites

install:

- Node.js v18.17 or later  
- npm v9 or later  
- git v2.14.1 or later  
- AWS account

## setup

create project:

```console
npm create next-app@14 -- next-amplify-gen2 --typescript --eslint --app --no-src-dir --no-tailwind --import-alias '@/*'
cd next-amplify-gen2
npm create amplify@latest
? Where should we create your project? (.) # press enter
npm run dev
```

Open [localhost:3000](http://localhost:3000/) in a browser to check server is running.

Hit `Ctrl + c` in command prompt window to stop dev server and open project in IDE.

Setup `git config user` email and name parameters.

Add `.idea` folder to `.gitignore` file in case of using JetBrains IDE like WebStorm.

---

## sandbox

[sandbox CLI commands](https://docs.amplify.aws/gen2/reference/cli-commands/)

In terminal:

```console
npm run dev
npx amplify sandbox
```

Hit `Ctrl + c` in sandbox terminal to stop, you may choose to keep it for further usage.

---

## Build a backend

### Add data

File `/amplify/data/resource.ts`:

```ts
import { type ClientSchema, a, defineData } from '@aws-amplify/backend';

const schema = a.schema({
  Todo: a
    .model({
      content: a.string(),
      done: a.boolean(),
      priority: a.enum(['low', 'medium', 'high'])
    })
      .authorization([a.allow.owner()]),
});

export type Schema = ClientSchema<typeof schema>;

export const data = defineData({
    schema,
    authorizationModes: {
        defaultAuthorizationMode: 'userPool'
    }
});
```

### Add authentication

File `amplify/auth/resource.ts`:

```ts
import { defineAuth } from '@aws-amplify/backend';

export const auth = defineAuth({
  loginWith: {
    email: {
      verificationEmailSubject: 'Welcome! Verify your email!'
    }
  },
  userAttributes: {
  },
});
```

---

## Build UI

### Add a login form

First, install the Amplify UI component library:

```console
npm install @aws-amplify/ui-react
```

If do not exist, create a `components` folder and root application folder `app` and create/modify `ConfigureAmplify.tsx` with following content:

```tsx
// components/ConfigureAmplify.tsx
"use client";

import config from "../../amplifyconfiguration.json";
import { Amplify } from "aws-amplify";

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
    return null;
}
```

Update `app/layout.tsx` to import and render `ConfigureAmplifyClientSide`. This client component will configure Amplify for client pages in our application:

```tsx
// app/layout.tsx
import ConfigureAmplifyClientSide from "./components/ConfigureAmplify";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
                                     children,
                                   }: {
  children: React.ReactNode;
}) {
  return (
      <html lang="en">
      <body className={inter.className}>
      <ConfigureAmplifyClientSide />
      {children}
      </body>
      </html>
  );
}
```

In `app/page.tsx`, update with the following code which import Amplify UI and wraps your App in the withAuthenticator function:

```tsx
// app/page.tsx
"use client";

import {signOut} from 'aws-amplify/auth';
import {withAuthenticator} from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

function App() {

    async function handleSignOut() {
        try {
            await signOut({global: true});
        } catch (error) {
            console.log('error signing out: ', error);
        }
    }

    return (
        <>
            <h1>Hello, Amplify ðŸ‘‹</h1>
            
            {/* Add a logout button */}
            <button onClick={handleSignOut}>Logout</button>
        </>
    );
}

export default withAuthenticator(App);
```

Run your application with `npm run dev` and navigate to [localhost:3000](http://localhost:3000). You should now see the authenticator, which is already configured and ready for your first sign-up! Create a new user account, confirm the account through email, and then sign in.

We also have added a logout button.

---

.. [wipp](https://docs.amplify.aws/gen2/start/quickstart/nextjs-app-router-client-components/#view-list-of-to-do-items)

---

...

---

Deploy amplify gen 2 be aware of !Next.js 14 apps require a minimum node version of 18.17 at build time.

Under Advanced settings, navigate to Build Image and enter `amplify:al2023`.  
The Amplify Amazon Linux 2023 build image supports Node.js versions 18 and 20 at build time.  
You can specify the Node.js version during your build via live package updates or nvm.  
Amplify Hosting will automatically deploy your compute runtime to match the Node.js version used at build time.

---
