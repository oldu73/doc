# App Router Client Components

Ref:

- [Next.js App Router (Client Components)](https://docs.amplify.aws/gen2/start/quickstart/nextjs-app-router-client-components/)  
- [GitHub repo next-amplify-gen2](https://github.com/oldu73/next-amplify-gen2)

---

## Prerequisites

install:

- Node.js v18.17 or later  
- npm v9 or later  
- git v2.14.1 or later  
- AWS account

## Setup

create project:

```console
npm create next-app@14 -- next-amplify-gen2 --typescript --eslint --app --no-src-dir --no-tailwind --import-alias '@/*'
cd next-amplify-gen2
npm create amplify@latest
? Where should we create your project? (.) # press enter
npm run dev
```

Open [localhost:3000](http://localhost:3000/) in a browser to check server is running.

Hit `Ctrl + c` in command prompt window to stop dev server and open project in IDE.

Setup `git config user` email and name parameters.

Add `.idea` folder to `.gitignore` file in case of using JetBrains IDE like WebStorm.

---

## Sandbox

[sandbox CLI commands](https://docs.amplify.aws/gen2/reference/cli-commands/)

In terminal:

```console
npm run dev
npx amplify sandbox
```

Hit `Ctrl + c` in sandbox terminal to stop, you may choose to keep it for further usage.

---

## Build a backend

### Add data

File `/amplify/data/resource.ts`:

```ts
import { type ClientSchema, a, defineData } from '@aws-amplify/backend';

const schema = a.schema({
  Todo: a
    .model({
      content: a.string(),
      done: a.boolean(),
      priority: a.enum(['low', 'medium', 'high'])
    })
      .authorization([a.allow.owner()]),
});

export type Schema = ClientSchema<typeof schema>;

export const data = defineData({
    schema,
    authorizationModes: {
        defaultAuthorizationMode: 'userPool'
    }
});
```

### Add authentication

File `amplify/auth/resource.ts`:

```ts
import { defineAuth } from '@aws-amplify/backend';

export const auth = defineAuth({
  loginWith: {
    email: {
      verificationEmailSubject: 'Welcome! Verify your email!'
    }
  },
  userAttributes: {
  },
});
```

---

## Build UI

### Add a login form

First, install the Amplify UI component library:

```console
npm install @aws-amplify/ui-react
```

If do not exist, create a `components` folder and root application folder `app` and create/modify `ConfigureAmplify.tsx` with following content:

```tsx
// components/ConfigureAmplify.tsx
"use client";

import config from "../../amplifyconfiguration.json";
import { Amplify } from "aws-amplify";

Amplify.configure(config, { ssr: true });

export default function ConfigureAmplifyClientSide() {
    return null;
}
```

Update `app/layout.tsx` to import and render `ConfigureAmplifyClientSide`. This client component will configure Amplify for client pages in our application:

```tsx
// app/layout.tsx
import ConfigureAmplifyClientSide from "./components/ConfigureAmplify";
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
                                     children,
                                   }: {
  children: React.ReactNode;
}) {
  return (
      <html lang="en">
      <body className={inter.className}>
      <ConfigureAmplifyClientSide />
      {children}
      </body>
      </html>
  );
}
```

In `app/page.tsx`, update with the following code which import Amplify UI and wraps your App in the withAuthenticator function:

```tsx
// app/page.tsx
"use client";

import {signOut} from 'aws-amplify/auth';
import {withAuthenticator} from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";

function App() {

    async function handleSignOut() {
        try {
            await signOut({global: true});
        } catch (error) {
            console.log('error signing out: ', error);
        }
    }

    return (
        <>
            <h1>Hello, Amplify ðŸ‘‹</h1>
            
            {/* Add a logout button */}
            <button onClick={handleSignOut}>Logout</button>
        </>
    );
}

export default withAuthenticator(App);
```

Run your application with `npm run dev` and navigate to [localhost:3000](http://localhost:3000).

You should now see the authenticator.

Create a new user account, confirm the account through email, and then sign in.

We also have added a logout button.

## View list of to-do items

Now, let's display data on our app's frontend.

In the `components` directory create a `TodoList.tsx` file with following content:

```tsx
// components/TodoList.tsx
"use client";

import { useState, useEffect } from "react";
import { generateClient } from "aws-amplify/data";
import type { Schema } from "../../amplify/data/resource";

// generate your data client using the Schema from your backend
const client = generateClient<Schema>();

export default function TodoList() {
    const [todos, setTodos] = useState<Schema["Todo"][]>([]);

    async function listTodos() {
        // fetch all todos
        const { data } = await client.models.Todo.list();
        setTodos(data);
    }

    useEffect(() => {
        listTodos();
    }, []);

    return (
        <div>
            <h1>Todos</h1>
            <ul>
                {todos.map((todo) => (
                    <li key={todo.id}>{todo.content}</li>
                ))}
            </ul>
        </div>
    );
}
```

In `app/page.tsx`, import components/TodoList and render it:

```tsx
// app/page.tsx
"use client";

import {signOut} from 'aws-amplify/auth';
import {withAuthenticator} from "@aws-amplify/ui-react";
import "@aws-amplify/ui-react/styles.css";
import TodoList from "./components/TodoList";

function App() {

    async function handleSignOut() {
        try {
            await signOut({global: true});
        } catch (error) {
            console.log('error signing out: ', error);
        }
    }

    return (
        <>
            <h1>Hello, Amplify ðŸ‘‹</h1>

            {/* Add a logout button */}
            <button onClick={handleSignOut}>Logout</button>

            <TodoList />
        </>
    );
}

export default withAuthenticator(App);
```

Once you save the file and navigate back to [localhost:3000](http://localhost:3000), you should see a blank page for an empty list of to-dos.

### Create a new to-do item

Update the return statement of the `components/TodoList` component to have a button for creating a new to-do list item:

```tsx
// components/TodoList.tsx
"use client";

import { useState, useEffect } from "react";
import { generateClient } from "aws-amplify/data";
import type { Schema } from "../../amplify/data/resource";

// generate your data client using the Schema from your backend
const client = generateClient<Schema>();

export default function TodoList() {
    const [todos, setTodos] = useState<Schema["Todo"][]>([]);

    async function listTodos() {
        // fetch all todos
        const { data } = await client.models.Todo.list();
        setTodos(data);
    }

    useEffect(() => {
        listTodos();
    }, []);

    return (
        <div>
            <h1>Todos</h1>
            <button onClick={async () => {
                // create a new Todo with the following attributes
                const { errors, data: newTodo } = await client.models.Todo.create({
                    // prompt the user to enter the title
                    content: window.prompt("title"),
                    done: false,
                    priority: 'medium'
                })
                console.log(errors, newTodo);
            }}>Create </button>

            <ul>
                {todos.map((todo) => (
                    <li key={todo.id}>{todo.content}</li>
                ))}
            </ul>
        </div>
    );
}
```

Create a couple of to-dos, then refresh the page to see them.

You can also subscribe to new to-dos in your `useEffect` to have them live reload on the page:

```tsx
// components/TodoList.tsx
"use client";

import {useState, useEffect} from "react";
import {generateClient} from "aws-amplify/data";
import type {Schema} from "../../amplify/data/resource";

// generate your data client using the Schema from your backend
const client = generateClient<Schema>();

export default function TodoList() {
    const [todos, setTodos] = useState<Schema["Todo"][]>([]);

    async function listTodos() {
        // fetch all todos
        const {data} = await client.models.Todo.list();
        setTodos(data);
    }

    useEffect(() => {
        listTodos();
    }, []);

    useEffect(() => {
        const sub = client.models.Todo.observeQuery().subscribe(({items}) =>
            setTodos([...items])
        );

        return () => sub.unsubscribe();
    }, []);

    return (
        <div>
            <h1>Todos</h1>
            <button onClick={async () => {
                // create a new Todo with the following attributes
                const {errors, data: newTodo} = await client.models.Todo.create({
                    // prompt the user to enter the title
                    content: window.prompt("title"),
                    done: false,
                    priority: 'medium'
                })
                console.log(errors, newTodo);
            }}>Create
            </button>

            <ul>
                {todos.map((todo) => (
                    <li key={todo.id}>{todo.content}</li>
                ))}
            </ul>
        </div>
    );
}
```

---

## Terminate dev server

Go to `localhost` in the browser to make sure you can now log in and create and list to-dos.

You can end your development session by shutting down the frontend dev server and cloud sandbox.

The sandbox prompts you to delete your backend resources.

While you can retain your backend, we recommend deleting all resources so you can start clean again next time.

---

## Deploy and host a fullstack branch

Now that your app is working, let's deploy it to a shared fullstack branch so you can share the project with your team.

Amplify offers a fully managed hosting service with CI/CD built in, making it easy to set up production and staging environments with Git branches.

**In Gen 2, every Git branch in your repository maps 1:1 to a fullstack branch in Amplify.**

In `Repository settings`, set up `Branch autodetection` to `ON`, `Branch autodetection access control` to `Restricted` and auto build, to achieve automatic fullstack environments set up and deploy that match git branches.

### Create remote Git repository

In local, check your git user basic parameters, name and email.

Check:

```console
git config user.email
git config user.name
```

Set:

```console
git config user.email "john@doe.com"
git config user.name "John Doe"
```

If you'r using a JetBrains IDE like WebStorm, add `.idea` folder to `.gitignore` file.

Git add all and initial commit:

```console
git add .
git commit -m "initial commit"
```

Create remote, **private** repository on GitHub.

Follow instruction in `â€¦or push an existing repository from the command line` section:

```console
git remote add origin https://github.com/<user name>/<project name>.git
git branch -M main
git push -u origin main
```

Give access to `AWS Amplify` application to this private repository:

- Click on user icon top right.  
- Settings  
- Applications  
- Click on `Configure` button for e.g. `AWS Amplify (us-east-1)`.  
- Add desired repository in list of selected repositories in `Repository access` section.

### Connect branch in the Amplify console

1. Log in to the [AWS console](https://aws.amazon.com/fr/console/) and navigate to your preferred AWS Region, to `AWS Amplify` service.  
2. Click on *Try Amplify Gen 2* preview banner.  
3. Choose *Option 2: Start with an existing app*.  
4. Click on *GitHub*, then click `Next`.  
5. Select repository and branch, then click `Next`.  
6. Set a user and password after checking `Password protect my site`.  
7. Under *Advanced settings*, navigate to *Build Image* and enter `amplify:al2023`. The Amplify Amazon Linux 2023 build image supports Node.js versions 18 and 20 at build time.  
8. Review all of your settings to ensure everything is set up correctly. Choose *Save and deploy* to deploy your web app.

If deployed project isn't password protected as it should be, browse to your app -> hosting -> access control and protect branch with `username` and `password`.

### Manage fullstack branch

The new Amplify console gives you a central place to manage your branches, hosting settings, CI/CD builds, and backend resources.

Even though you can access backend resources directly from AWS service consoles, the Amplify console offers built-in user and data administration.

### Deployed backend resources

Under application in Amplify click on `Deployed` branch link and then `Deployed backend resources` tab.

Filter out by `userpool` keyword to retrieve associated `Cognito UserPool`.

Filter out by `datasource` keyword to retrieve associated `AWS AppSync DataSource` then in bread crumb menu browse one level higher to retrieve link to associated `DynamoDB` table.

---

## Managed sandboxes

Under application in Amplify Overview you may observe deployed sandboxes and manage them by clicking on `Manage sandboxes` button.

---
